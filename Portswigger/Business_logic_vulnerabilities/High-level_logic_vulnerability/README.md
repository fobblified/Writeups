# High-level logic vulnerability

## Theory

<h3>Неспособность обрабатывать нетрадиционный ввод</h3>

Одной из целей логики приложения является ограничение пользовательского ввода значениями, которые соответствуют бизнесс-правилам. Например, приложение может принимать произвольные значения определенного типа данных, но логика определяет, является ли это значение приемлемым с точки зрения бизнеса. Многие приложения включают числовые ограничения в свою логику. Сюда могут входить ограничения, предназначенные для управления запасами, применения бюджетных ограничений, инициирования этапов цепочки поставок и т. д.

Возьмем простой пример интернет-магазина. При заказе продуктов пользователи обычно указывают количество, которое они хотят заказать. Хотя любое целое число теоретически допустимо, бизнес-логика например может запретить пользователям заказывать больше единиц товара, чем имеется в наличии.

Чтобы реализовать такие правила, разработчикам необходимо предусмотреть все возможные сценарии и включить способы их обработки в логику приложения. Другими словами, они должны сообщить приложению, должно ли оно разрешать данный ввод и как оно должно реагировать в зависимости от различных условий. Если нет явной логики для обработки данного случая, это может привести к неожиданному и потенциально опасному поведению.

Например, числовой тип данных может принимать отрицательные значения. В зависимости от связанной функциональности бизнес-логика может не допускать этого. Однако, если приложение не выполняет адекватную проверку на стороне сервера и не отклоняет этот ввод, злоумышленник может передать отрицательное значение и вызвать нежелательное поведение.

Рассмотрим перевод средств между двумя банковскими счетами. Эта функция почти наверняка проверит, достаточно ли средств у отправителя, прежде чем завершить перевод.
```
$transferAmount = $_POST['amount'];
$currentBalance = $user->getBalance();

if ($transferAmount <= $currentBalance) {
    // Complete the transfer
} else {
    // Block the transfer: insufficient funds
}
```

Но если логика недостаточно препятствует тому, чтобы пользователи указывали отрицательное значение в параметре суммы, злоумышленник может использовать это как для обхода проверки баланса, так и для перевода средств в «неправильном» направлении. Если злоумышленник отправил -1000 долларов на счет жертвы, вместо этого он может получить 1000 долларов от жертвы. Логика всегда будет оценивать, что -1000 меньше текущего баланса, и одобрять перевод.

Простые логические ошибки, подобные этой, могут иметь разрушительные последствия, если они возникают в правильной функциональности. Их также легко пропустить как во время разработки, так и во время тестирования, особенно с учетом того, что такие входные данные могут быть заблокированы элементами управления на стороне клиента в веб-интерфейсе.

При аудите приложения вы должны использовать такие инструменты, как Burp Proxy и Repeater, чтобы попытаться отправить нестандартные значения. В частности, попробуйте ввести диапазоны, которые законные пользователи вряд ли когда-либо введут. Это включает в себя исключительно высокие или исключительно низкие числовые входные данные и ненормально длинные строки для текстовых полей. Вы даже можете попробовать неожиданные типы данных. Наблюдая за реакцией приложения, вы должны попытаться ответить на следующие вопросы:

* Существуют ли какие-либо ограничения, которые накладываются на данные?
* Что происходит, когда мы достигаем этих пределов?
* Выполняется ли какое-либо преобразование или нормализация вашего ввода?

Это может привести к слабой проверке ввода, что позволит вам манипулировать приложением необычным образом. Имейте в виду, что если вы найдете одну форму на целевом веб-сайте, которая не может безопасно обрабатывать нетрадиционный ввод, вполне вероятно, что другие формы будут иметь те же проблемы.

## Writeup

* Имеющиеся данные: 
    * Данные нашего аккаунта: wiener:peter

Главная страница:

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/1.png)

Логинимся с имеющимися данными.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/2.png)

Перейдем на главную страницу и добавим в корзину товар, который нужно преобрести.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/3.png)

Перейдем в корзину. Мы видим, что данный товар стоит больше, чем есть у нас.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/4.png)

Снова перейдем на гланую страницу и выберем другой товар.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/5.png)

Перейдем в корзину. Попробуем уменьшить количество нашего нового доавленного товара в отрицательное количество.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/6.png)

Нажмем на минус и перехватим запрос. Мы можем видеть число на которое будет уведичиваться/уменьшаться количество товара в корзине.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/7.png)

Изменим это значение на отрицательное.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/8.png)

Отправляем запрос. Видим, что теперь мы можем купить требуемый продукт.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/9.png)

Размещаем заказ и получаем ответ от сервера.

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/10.png)

![](https://github.com/fobblified/Writeups/blob/main/Portswigger/Business_logic_vulnerabilities/High-level_logic_vulnerability/assets/11.png)
